#!/bin/bash
# ==============================================================================
# –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ UFW firewall –¥–ª—è UPVS API
# ==============================================================================

set -e

echo "üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UFW Firewall"
echo "=========================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å sudo"
    exit 1
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ UFW –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v ufw &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ UFW..."
    apt-get update
    apt-get install -y ufw
fi

# –°–±—Ä–æ—Å –ø—Ä–∞–≤–∏–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
# echo "üîÑ –°–±—Ä–æ—Å –ø—Ä–∞–≤–∏–ª UFW..."
# ufw --force reset

# –ü–æ–ª–∏—Ç–∏–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
echo "üö´ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–ª–∏—Ç–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é..."
ufw default deny incoming
ufw default allow outgoing

# –†–∞–∑—Ä–µ—à–∏—Ç—å SSH (–í–ê–ñ–ù–û!)
echo "‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ SSH (–ø–æ—Ä—Ç 22)..."
ufw allow OpenSSH
ufw allow 22/tcp comment 'SSH'

# –†–∞–∑—Ä–µ—à–∏—Ç—å HTTPS
echo "‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ HTTPS (–ø–æ—Ä—Ç 443)..."
ufw allow 443/tcp comment 'HTTPS'

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: HTTP –¥–ª—è Let's Encrypt
read -p "‚ùì –†–∞–∑—Ä–µ—à–∏—Ç—å HTTP (–ø–æ—Ä—Ç 80) –¥–ª—è Let's Encrypt? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ HTTP (–ø–æ—Ä—Ç 80)..."
    ufw allow 80/tcp comment 'HTTP (Let\'s Encrypt)'
fi

# –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞
echo ""
echo "üìã –¢–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞:"
ufw show added

# –í–∫–ª—é—á–∏—Ç—å UFW
echo ""
read -p "‚ùì –í–∫–ª—é—á–∏—Ç—å UFW —Å–µ–π—á–∞—Å? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üîê –í–∫–ª—é—á–µ–Ω–∏–µ UFW..."
    ufw --force enable
    
    echo ""
    echo "‚úÖ UFW –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≤–∫–ª—é—á—ë–Ω!"
    echo ""
    ufw status verbose
else
    echo "‚ö†Ô∏è  UFW –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –Ω–æ –Ω–µ –≤–∫–ª—é—á—ë–Ω. –í–∫–ª—é—á–∏—Ç–µ –≤—Ä—É—á–Ω—É—é: sudo ufw enable"
fi

echo ""
echo "============================================"
echo "‚úÖ Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
echo ""
echo "üìä –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã:"
echo "   - 22 (SSH)"
echo "   - 443 (HTTPS)"
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "   - 80 (HTTP - –¥–ª—è Let's Encrypt)"
fi
echo ""
echo "üîí –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã –ó–ê–ö–†–´–¢–´"
echo "============================================"

