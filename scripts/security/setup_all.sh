#!/bin/bash
# ==============================================================================
# ĞœĞ°ÑÑ‚ĞµÑ€-ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ UPVS API
# ==============================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                            â•‘"
echo "â•‘         UPVS API - ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸                 â•‘"
echo "â•‘                                                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ²
if [ "$EUID" -ne 0 ]; then 
    echo "âŒ Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ñ sudo:"
    echo "   sudo bash scripts/security/setup_all.sh"
    exit 1
fi

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞĞ¡
if [ ! -f /etc/debian_version ]; then
    echo "âš ï¸  Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¿Ñ€ĞµĞ´Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ Ğ´Ğ»Ñ Debian/Ubuntu"
    read -p "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo "Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ:"
echo ""
echo "  1. âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹"
echo "  2. ğŸ”¥ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° UFW Firewall"
echo "  3. ğŸ›¡ï¸  ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Fail2Ban"
echo "  4. ğŸ” Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° SSH"
echo "  5. â° ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹"
echo "  6. ğŸ³ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Docker logging"
echo ""
read -p "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾"
    exit 0
fi

# =============================================
# 1. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
# =============================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1ï¸âƒ£  ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
apt-get update
apt-get upgrade -y
apt-get install -y curl wget git nano htop unattended-upgrades logrotate

# =============================================
# 2. UFW Firewall
# =============================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "2ï¸âƒ£  ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° UFW Firewall"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
bash "$SCRIPT_DIR/setup_firewall.sh"

# =============================================
# 3. Fail2Ban
# =============================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "3ï¸âƒ£  ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Fail2Ban"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
bash "$SCRIPT_DIR/setup_fail2ban.sh"

# =============================================
# 4. SSH Hardening
# =============================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "4ï¸âƒ£  Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° SSH"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
read -p "â“ Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ¸Ñ‚ÑŒ SSH? (Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ÑÑ SSH ĞºĞ»ÑÑ‡Ğ¸!) (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    bash "$SCRIPT_DIR/harden_ssh.sh"
else
    echo "â­ï¸  ĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾"
fi

# =============================================
# 5. ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
# =============================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "5ï¸âƒ£  ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
dpkg-reconfigure -plow unattended-upgrades
echo "âœ… ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹"

# =============================================
# 6. Docker logging
# =============================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "6ï¸âƒ£  ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Docker logging"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if command -v docker &> /dev/null; then
    echo "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ /etc/docker/daemon.json..."
    mkdir -p /etc/docker
    
    cat > /etc/docker/daemon.json << 'EOF'
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
EOF
    
    echo "ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Docker..."
    systemctl restart docker
    echo "âœ… Docker logging Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½"
else
    echo "â­ï¸  Docker Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾"
fi

# =============================================
# Ğ˜Ñ‚Ğ¾Ğ³Ğ¸
# =============================================
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                            â•‘"
echo "â•‘              âœ… ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ!                       â•‘"
echo "â•‘                                                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ”’ Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°:"
echo ""
echo "   âœ… UFW Firewall - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 22, 443 Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹"
echo "   âœ… Fail2Ban - Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ±Ñ€ÑƒÑ‚Ñ„Ğ¾Ñ€ÑĞ°"
echo "   âœ… SSH - Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ñ‘Ğ½ (ĞµÑĞ»Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾)"
echo "   âœ… ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ - Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹"
echo "   âœ… Docker logging - Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ñ‹"
echo ""
echo "ğŸ“‹ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸:"
echo ""
echo "   1. Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑĞµĞºÑ€ĞµÑ‚Ñ‹:"
echo "      bash scripts/generate_secrets.sh > .env"
echo ""
echo "   2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Nginx:"
echo "      sudo cp nginx/upvs-secure.conf /etc/nginx/sites-available/upvs"
echo "      sudo ln -s /etc/nginx/sites-available/upvs /etc/nginx/sites-enabled/"
echo "      (ĞĞµ Ğ·Ğ°Ğ±ÑƒĞ´ÑŒÑ‚Ğµ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ your-domain.com!)"
echo ""
echo "   3. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚:"
echo "      sudo certbot --nginx -d your-domain.com"
echo ""
echo "   4. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚:"
echo "      docker compose up -d"
echo ""
echo "   5. Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ OpenAPI schema:"
echo "      docker compose exec api python scripts/export_openapi.py"
echo ""
echo "ğŸ‰ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğº Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ñƒ!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

