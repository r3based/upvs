#!/bin/bash
# =============================================================================
# –ë—ã—Å—Ç—Ä–∞—è —à–ø–∞—Ä–≥–∞–ª–∫–∞ –∫–æ–º–∞–Ω–¥ –¥–ª—è –¥–µ–ø–ª–æ—è UPVS API
# –î–æ–º–µ–Ω: upvs.duckdns.org
# IP: 176.126.103.147
# =============================================================================

echo "üöÄ UPVS API - –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è"
echo "================================"
echo ""
echo "–î–æ–º–µ–Ω: upvs.duckdns.org"
echo "IP: 176.126.103.147"
echo ""

# =============================================================================
# –®–ê–ì 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
# =============================================================================
cat << 'EOF'
üìù –®–ê–ì 1: –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
---------------------------------
ssh root@176.126.103.147
# –∏–ª–∏
ssh ubuntu@176.126.103.147

EOF

# =============================================================================
# –®–ê–ì 2: –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
# =============================================================================
cat << 'EOF'
üìù –®–ê–ì 2: –û–±–Ω–æ–≤–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É
--------------------------
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl wget git nano

EOF

# =============================================================================
# –®–ê–ì 3: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
# =============================================================================
cat << 'EOF'
üìù –®–ê–ì 3: –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
------------------------------------
# –í–∞—Ä–∏–∞–Ω—Ç –ê: –ß–µ—Ä–µ–∑ Git
git clone YOUR_REPO_URL upvs
cd upvs

# –í–∞—Ä–∏–∞–Ω—Ç –ë: –ß–µ—Ä–µ–∑ SCP (—Å –≤–∞—à–µ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞):
# cd /home/r3taker/Work/upvs_new
# tar -czf upvs.tar.gz upvs/
# scp upvs.tar.gz root@176.126.103.147:~/
# 
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
# tar -xzf upvs.tar.gz
# cd upvs

EOF

# =============================================================================
# –®–ê–ì 4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
# =============================================================================
cat << 'EOF'
üìù –®–ê–ì 4: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
----------------------------------------------
cd ~/upvs
sudo bash scripts/security/setup_all.sh

# –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç:
# - UFW Firewall
# - Fail2Ban
# - SSH hardening
# - –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
# - Docker logging

EOF

# =============================================================================
# –®–ê–ì 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤
# =============================================================================
cat << 'EOF'
üìù –®–ê–ì 5: –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã
------------------------------
cd ~/upvs
bash scripts/generate_secrets.sh > .env

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –°–û–•–†–ê–ù–ò–¢–ï —Å–µ–∫—Ä–µ—Ç—ã:
cat .env

EOF

# =============================================================================
# –®–ê–ì 6: Docker
# =============================================================================
cat << 'EOF'
üìù –®–ê–ì 6: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker
---------------------------
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
rm get-docker.sh
sudo apt install -y docker-compose-plugin

# –ü—Ä–æ–≤–µ—Ä–∫–∞:
docker --version
docker compose version

EOF

# =============================================================================
# –®–ê–ì 7: Nginx
# =============================================================================
cat << 'EOF'
üìù –®–ê–ì 7: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Nginx
--------------------------------------
sudo apt install -y nginx

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥
cd ~/upvs
sudo cp nginx/upvs-secure.conf /etc/nginx/sites-available/upvs
sudo ln -s /etc/nginx/sites-available/upvs /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
sudo nginx -t
sudo systemctl reload nginx

EOF

# =============================================================================
# –®–ê–ì 8: SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
# =============================================================================
cat << 'EOF'
üìù –®–ê–ì 8: –ü–æ–ª—É—á–∏—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
---------------------------------
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d upvs.duckdns.org

# –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º Certbot
# - –í–≤–µ–¥–∏—Ç–µ email
# - –°–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏

EOF

# =============================================================================
# –®–ê–ì 9: –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# =============================================================================
cat << 'EOF'
üìù –®–ê–ì 9: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
------------------------------
cd ~/upvs
docker compose up -d

# –°–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
docker compose logs -f init

# –ü–æ—Å–ª–µ "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞" - Ctrl+C

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
docker compose ps

EOF

# =============================================================================
# –®–ê–ì 10: –ü—Ä–æ–≤–µ—Ä–∫–∞
# =============================================================================
cat << 'EOF'
üìù –®–ê–ì 10: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
--------------------------
# Health check
curl https://upvs.duckdns.org/health

# –° API –∫–ª—é—á–æ–º
API_KEY=$(grep API_KEY ~/upvs/.env | cut -d= -f2)
curl -H "Authorization: Bearer $API_KEY" \
     https://upvs.duckdns.org/api/tree | jq '.total_pages'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–ª—É–∂–µ–±–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∑–∞–∫—Ä—ã—Ç—ã
curl https://upvs.duckdns.org/docs
# –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: 404

curl https://upvs.duckdns.org/openapi.json
# –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: 404

EOF

# =============================================================================
# –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
# =============================================================================
cat << 'EOF'
üîß –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´
===================

# –õ–æ–≥–∏
docker compose logs -f api
docker compose logs -f postgres

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
docker compose restart api

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker compose down

# –ü—Ä–æ–≤–µ—Ä–∫–∞ firewall
sudo ufw status

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Fail2Ban
sudo fail2ban-client status

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL
sudo certbot certificates

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx
sudo nginx -t
sudo systemctl status nginx

EOF

echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –°–ª–µ–¥—É–π—Ç–µ —à–∞–≥–∞–º –≤—ã—à–µ –¥–ª—è –¥–µ–ø–ª–æ—è."

